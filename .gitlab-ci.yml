variables:
  GIT_STRATEGY: none
  GIT_SUBMODULE_STRATEGY: none

stages:
  - build
  - test

build-repos:
  stage: build
  tags:
    - bsg
  script:
    - echo "Cloning repos..."
    - rm -rf *
    - cp -r $BSG_CADENV_DIR bsg_cadenv
    - git clone https://github.com/bespoke-silicon-group/basejump_stl.git
    - git clone --recursive -b $CI_COMMIT_REF_NAME https://github.com/bespoke-silicon-group/bsg_manycore.git
    - git clone https://github.com/bespoke-silicon-group/bsg_f1.git 
    - echo "Building toolchain"
    - cd bsg_manycore/software/riscv-tools
    - make clean-all install-clean
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - $CI_PROJECT_DIR/bsg_cadenv
      - $CI_PROJECT_DIR/basejump_stl
      - $CI_PROJECT_DIR/bsg_manycore
      - $CI_PROJECT_DIR/bsg_f1
    policy: push

test-manycore:
  stage: test
  tags:
    - bsg
    - vcs
  script:
    - echo "Running Manycore regression..."
    - cd bsg_manycore
    - ./ci/regress.sh
  cache:
    paths:
      - $CI_PROJECT_DIR/bsg_cadenv
      - $CI_PROJECT_DIR/basejump_stl
      - $CI_PROJECT_DIR/bsg_manycore
      - $CI_PROJECT_DIR/bsg_f1
    policy: pull
  only:
    - merge_requests
    - master

test-cosim:
  when: manual
  stage: test
  tags:
    - bsg
    - vcs
  script:
    - echo "Running COSIM..."
    - cd bsg_f1/testbenches
    - make
  cache:
    paths:
      - $CI_PROJECT_DIR/bsg_cadenv
      - $CI_PROJECT_DIR/basejump_stl
      - $CI_PROJECT_DIR/bsg_manycore
      - $CI_PROJECT_DIR/bsg_f1
    policy: pull
