//  TEST DESCRIPTION
//  Every tile reads the array of integer and sum them up locally.
//  If everyone gets the correct sum, then the test passes.
//  Tiles generate multiple remote loads to create congestion in network.
//  this works for any number of tiles.

#include "bsg_manycore.h"
#include "bsg_set_tile_x_y.h"

#define BSG_TILE_GROUP_X_DIM bsg_tiles_X
#define BSG_TILE_GROUP_Y_DIM bsg_tiles_Y
#include "bsg_tile_group_barrier.h"
INIT_TILE_GROUP_BARRIER(r_barrier, c_barrier, 0, bsg_tiles_X-1, 0, bsg_tiles_Y-1);
#define N 1024



int data[N] __attribute__ ((section (".dram"))) = {
778,129,296,99,779,958,914,773,7,174,523,208,697,581,634,303,434,16,713,148,74,889,374,55,192,797,194,1009,430,291,907,717,
172,860,98,766,283,883,909,613,163,37,873,623,638,373,384,173,247,401,9,799,870,186,205,118,768,995,243,165,814,177,964,130,
263,695,963,491,183,187,524,837,230,803,693,723,735,104,17,69,902,396,698,494,109,522,349,679,56,829,193,798,1021,571,96,114,
946,726,304,452,830,722,1010,372,912,246,887,159,50,876,77,219,233,557,672,286,1016,411,633,222,544,314,882,767,195,917,596,164,
911,151,716,270,869,944,940,669,549,423,921,298,663,707,319,78,474,761,254,750,12,886,480,379,572,724,775,107,478,84,631,719,
60,15,600,935,583,899,701,533,157,950,284,375,28,180,848,806,632,20,450,841,67,447,619,772,991,58,142,144,346,738,548,997,
495,320,489,166,603,179,403,916,650,800,400,259,101,388,743,108,451,531,110,546,538,539,30,888,426,733,579,266,731,14,690,281,
2,128,200,787,694,974,753,202,94,1005,1,714,801,290,550,331,892,265,354,595,1006,943,261,580,120,239,836,575,704,827,745,386,
627,874,317,503,242,333,345,680,661,40,473,589,594,885,578,467,545,851,700,730,338,718,87,307,214,518,4,410,465,10,994,515,
640,471,670,282,106,353,853,496,795,709,835,485,897,454,569,859,146,169,985,115,930,526,124,990,207,905,979,926,13,414,933,702,
691,103,674,288,705,736,241,951,637,327,275,609,182,689,699,237,201,389,184,76,3,425,381,953,810,420,132,399,998,391,732,438,
765,43,316,547,352,416,441,922,5,363,390,793,82,121,213,643,85,328,271,749,746,960,507,764,927,178,554,191,687,88,675,133,
1019,879,802,34,591,744,90,6,429,646,645,520,823,31,747,79,469,574,238,260,272,302,368,925,455,989,404,458,629,1022,794,468,
1014,492,896,819,326,666,708,138,293,366,855,542,167,312,652,809,788,134,607,978,44,506,140,644,849,443,1002,651,817,562,551,769,
424,552,821,362,75,662,185,334,342,536,516,38,23,786,292,831,232,466,878,83,741,63,614,906,513,969,348,32,405,325,664,313,
982,51,1020,739,116,59,654,517,903,528,206,428,593,755,863,822,947,582,585,329,1012,1015,397,590,227,70,555,789,965,460,487,11,
323,196,1001,783,612,586,22,408,145,890,543,223,942,453,86,949,477,866,688,355,406,93,521,339,175,52,630,152,277,1023,790,27,
824,269,759,683,235,904,1003,46,336,807,611,784,588,154,240,934,295,422,980,322,617,525,1017,19,535,901,448,948,459,676,359,407,
681,857,734,656,412,758,725,212,123,838,48,684,653,791,868,847,53,100,190,510,975,402,481,153,988,658,939,250,751,685,932,137,
665,351,156,508,490,464,567,340,881,842,24,61,72,245,62,311,606,226,125,502,126,677,556,197,332,720,537,211,419,601,710,210,
559,532,392,900,514,748,781,983,476,530,446,893,721,977,343,417,923,560,584,981,752,256,344,570,161,636,264,248,147,534,616,395,
762,385,808,774,21,780,564,36,678,936,957,95,47,309,68,387,604,987,639,463,136,540,872,382,895,792,642,621,267,815,337,973,
117,449,968,421,216,357,919,162,692,756,509,967,39,249,962,573,160,461,199,1018,620,828,367,220,1013,785,341,398,335,972,377,635,
941,577,262,565,871,244,413,648,813,938,475,42,378,659,826,880,850,655,361,920,727,209,257,92,796,867,833,221,66,1008,189,563,
176,289,945,484,432,360,445,456,999,811,321,493,105,884,393,924,143,812,81,706,816,278,782,599,35,294,820,57,686,956,231,394,
804,862,908,198,488,65,376,712,970,770,910,297,894,371,846,234,80,301,71,625,844,737,504,102,597,649,498,25,273,929,236,865,
668,45,280,155,330,856,618,168,251,347,188,435,279,760,971,149,41,805,984,33,891,861,818,113,409,1004,418,854,364,440,500,439,
64,541,433,350,558,771,318,315,158,839,89,119,224,127,8,915,300,203,641,171,628,624,843,479,287,610,1011,258,742,299,511,937,
931,499,505,776,961,976,370,728,497,356,73,587,519,864,992,986,553,97,483,111,141,442,845,358,918,457,602,757,26,431,954,626,
566,996,512,472,268,462,622,217,1007,527,215,660,285,955,229,673,253,49,754,993,615,667,840,501,608,576,657,218,696,592,529,858,
18,150,54,308,852,763,777,305,605,131,729,436,415,122,877,647,427,832,913,928,274,306,959,310,369,170,324,139,29,966,834,444,
561,682,383,365,91,482,255,486,898,671,740,825,703,204,711,598,181,1000,228,380,276,470,252,135,437,112,715,568,952,225,875,0
};


int main()
{
  bsg_set_tile_x_y();
  
  // everyone loads (starting from different idx)
  int sum = 0;
  int curr_idx = __bsg_id*8;

  for (int i = 0; i < N/8; i++)
  {
    int idx = (curr_idx + (8*i)) % N; 
    int data0 = data[idx+0];
    int data1 = data[idx+1];
    int data2 = data[idx+2];
    int data3 = data[idx+3];
    int data4 = data[idx+4];
    int data5 = data[idx+5];
    int data6 = data[idx+6];
    int data7 = data[idx+7];
    sum += (data0 + data1 + data2 + data3 + data4 + data5 + data6 + data7);
  }

  // validate
  if (sum != 523776) bsg_fail();

  // join barrier
  bsg_tile_group_barrier(&r_barrier, &c_barrier);  

  if (__bsg_id == 0) 
  {
    bsg_finish();
  }
  else
  {
    bsg_wait_while(1);
  }


}

