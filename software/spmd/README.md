SPMD Directory
==============


Writing your own spmd program
-----------------------------
Refer to 'hello/' as an example.
In spmd, the default tile group dimension is the full array. The test should be written so that it works for any size of array.
If not, (i.e. it runs only on a single tile), then specify bsg_tiles_X and bsg_tiles_Y in makefile.

Running single spmd program
---------------------------

In any of the sub-directories:
- `make`: Run VCS simulation.
- `make WAVE=1` Run VCS simulation with waveform dump.
- `make main.riscv`: Generate ELF binary of that SPMD program.
- `make main.dis`: Print disassembly to the terminal.
- `vanilla.log`: Vanilla core trace dumped during the simulation.

Note: In directories containing multiple SPMD programs, `bsg_riscv_tests/` for instance,
`main` has to be replaced by the program name. For example, to generate ELF binary of
`add` riscv test, you have to run `make add.riscv`.



Manycore regression
-------------------

RTL regression testing of the manycore.

`make [<flag>=<value>]...`

Some useful flags:

- `GROUP=<group>`: Run only tests in a specific group. `<group>` can be one of the following...
    - `rv32ui`
    - `rv32um`
    - `spmd`
    - `coremark`
    - `beebs`
- `LEVEL=<level>`: Run different levels of regression. `<level>`=1 => group 0, `<level>`=2 => group 0, 1 and so on. **Default is `LEVEL=3`. Level 3 regression suceess is required for changes to be accepted into master.**
- `bsg_tiles_X`:
    Can be used to specify the number of rows to be instantiated. Default
    value provided in individual testcases.
- `bsg_tiles_Y`:
    Can be used to specify the number of columns to be instantiated. Default
    value provided in individual testcases.
- `COVERAGE=VCS`:
    RTL Coverage analysis using VCS. Coverage reports generated using
    Unified Coverage Genrator (URG). Default configuration used for
    the coverage analysis is 4x4. This will be overwritten only when
    above dimension variables are explicitly set.
- `ENABLE_VCACHE={0|1}`:
    include vcache or instead include block SRAM.

Note: 
    Current design is only tested for x<=4, y<=4 and dimensions mentioned in
    individual testcases.



`common/`
----------

Common resources used by all SPMD programs.

- `common/crt.S`:
  - C runtime code for BSG Manycore.
  - Intializes stack pointer `sp`, thread pointer `tp` and global pointer `gp`.
  - Initializes rest of the general purpose registers to `0`.
  - Calls `main` function.
  - **Doesn't call a exit routine! SPMD programs should call `bsg_finish()` to exit.**

- `common/link_dmem.ld`:
  - Link script for programs in which data & stack can fit in DMEM.
  - Places all data sections in DMEM, `.dram` section and text sections in DRAM.
  - `sp` is initialized to the end of DMEM -- `0x1ffc`.
  - Data can be placed in DRAM by explcitly attributing it to `.dram` section.
  - **Default link script for programs in this directory.**

- `common/link_dram.ld`:
  - Link script to run larger programs.
  - Places `.dmem` and sections in `bsg_manycore_lib.a` in DMEM and all other sections in DRAM.
  - `sp` is initialized to the end of DRAM -- `0xfffffffc`.

- ELF binaries generated by manycore's link scripts follows memory layout described [here](
https://docs.google.com/document/d/1b2g2nnMYidMkcn6iHJ9NGjpQYfZeWEmMdLeO_3nLtgo/edit#bookmark=id.6ta2llhb2shf).
  
- Special sybmols defined in manycore's link scripts:
  - `_bsg_data_start_addr`: Begin NPA of DMEM data segment.
  - `_bsg_data_end_addr`: End NPA of DMEM data segment.
  - `_bsg_dram_t_start_addr`: Begin NPA of DRAM text segment.
  - `_bsg_dram_t_end_addr`: End NPA of DRAM text segment.
  - `_bsg_dram_d_start_addr`: Begin NPA of DRAM data segment.
  - `_bsg_dram_d_end_addr`: End NPA of DRAM data segment.
  - `_bsg_dram_end_addr`: Heap pointer.
  - `_sp`: Initial stack pointer. `crt.S` uses this symbol to initialize `sp`.
  - `_gp`: Global pointer. `crt.S` uses this symbol to initialize `gp`.
