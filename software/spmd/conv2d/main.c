
#include "bsg_manycore.h"
#include "bsg_set_tile_x_y.h"

#ifndef NOP_WAIT
#define NOP_WAIT 0
#endif

#ifndef ITERATIONS
#define ITERATIONS 10
#endif

#define abs(x) ((x) < 0 ? -1 * (x) : (x))

#define ISIZE 16
#define KSIZE 3
#define OSIZE 14
float input[256]    __attribute__ ((section ("dmem"))) = {0.49625658988952637, 0.7682217955589294, 0.08847743272781372, 0.13203048706054688, 0.30742281675338745, 0.6340786814689636, 0.4900934100151062, 0.8964447379112244, 0.455627977848053, 0.6323062777519226, 0.3488934636116028, 0.40171730518341064, 0.022325754165649414, 0.16885894536972046, 0.2938884496688843, 0.518521785736084, 0.6976675987243652, 0.800011396408081, 0.16102945804595947, 0.28226858377456665, 0.6816085577011108, 0.9151939749717712, 0.39709991216659546, 0.8741558790206909, 0.41940832138061523, 0.5529070496559143, 0.9527381062507629, 0.036164820194244385, 0.1852310299873352, 0.37341737747192383, 0.3051000237464905, 0.9320003986358643, 0.17591017484664917, 0.2698335647583008, 0.15067976713180542, 0.03171950578689575, 0.20812976360321045, 0.9297990202903748, 0.7231091856956482, 0.7423362731933594, 0.5262957811355591, 0.24365824460983276, 0.584592342376709, 0.033152639865875244, 0.13871687650680542, 0.242235004901886, 0.815468966960907, 0.793160617351532, 0.2782524824142456, 0.48195880651474, 0.8197803497314453, 0.9970665574073792, 0.6984410881996155, 0.5675464272499084, 0.8352431654930115, 0.2055988311767578, 0.593172013759613, 0.11234724521636963, 0.1534569263458252, 0.24170821905136108, 0.7262365221977234, 0.7010802030563354, 0.2038237452507019, 0.6510535478591919, 0.7744860053062439, 0.4368913173675537, 0.5190907716751099, 0.6158523559570312, 0.8101882934570312, 0.9800970554351807, 0.1146882176399231, 0.3167651295661926, 0.6965049505233765, 0.9142746925354004, 0.9351036548614502, 0.9411783814430237, 0.5995072722434998, 0.06520867347717285, 0.5459962487220764, 0.18719732761383057, 0.03402292728424072, 0.944246232509613, 0.8801798820495605, 0.0012360215187072754, 0.5935860276222229, 0.4157699942588806, 0.41771942377090454, 0.2711215615272522, 0.6922780871391296, 0.2038482427597046, 0.6832956671714783, 0.75285404920578, 0.8579357862472534, 0.6869555711746216, 0.0051323771476745605, 0.17565155029296875, 0.7496575117111206, 0.6046506762504578, 0.1099579930305481, 0.21209025382995605, 0.9703746438026428, 0.8369089365005493, 0.28198742866516113, 0.3741576075553894, 0.023700952529907227, 0.49101293087005615, 0.12347054481506348, 0.11432164907455444, 0.4724501967430115, 0.5750725269317627, 0.2952348589897156, 0.7966887950897217, 0.19573044776916504, 0.9536850452423096, 0.8426499366760254, 0.07835853099822998, 0.3755578398704529, 0.5225613117218018, 0.572950541973114, 0.6185871362686157, 0.6962141394615173, 0.5299500823020935, 0.25603562593460083, 0.7365944981575012, 0.020375549793243408, 0.20364665985107422, 0.3748350739479065, 0.2564433217048645, 0.32508331537246704, 0.09018915891647339, 0.3936424255371094, 0.6068782210350037, 0.17426711320877075, 0.4743403196334839, 0.8579254150390625, 0.4485998749732971, 0.513896107673645, 0.4568655490875244, 0.6011906862258911, 0.8179197311401367, 0.9736230969429016, 0.8175279498100281, 0.974706768989563, 0.46383917331695557, 0.050839245319366455, 0.26296138763427734, 0.8404526114463806, 0.49675875902175903, 0.25147682428359985, 0.11684411764144897, 0.032073974609375, 0.0779958963394165, 0.3985816240310669, 0.7742030024528503, 0.7703205347061157, 0.017784059047698975, 0.8118910193443298, 0.108745276927948, 0.3942948579788208, 0.2972636818885803, 0.403692364692688, 0.4018286466598511, 0.05132502317428589, 0.06828105449676514, 0.4217602610588074, 0.5064660906791687, 0.2728625535964966, 0.6883496046066284, 0.049970805644989014, 0.46625638008117676, 0.9397097229957581, 0.29605400562286377, 0.9515015482902527, 0.6810768842697144, 0.04876953363418579, 0.816348671913147, 0.44230276346206665, 0.2767965793609619, 0.8998266458511353, 0.09595239162445068, 0.5536524653434753, 0.39531564712524414, 0.8570563197135925, 0.639572262763977, 0.740252673625946, 0.676579475402832, 0.3797626495361328, 0.3948472738265991, 0.08795928955078125, 0.770922064781189, 0.8969890475273132, 0.8421124219894409, 0.14731085300445557, 0.5222999453544617, 0.14753293991088867, 0.22475790977478027, 0.2086472511291504, 0.6708725094795227, 0.20204341411590576, 0.4890913963317871, 0.5210340619087219, 0.822311520576477, 0.12203997373580933, 0.1567438840866089, 0.20966923236846924, 0.8499667048454285, 0.3202674984931946, 0.9217443466186523, 0.6808037757873535, 0.5633130073547363, 0.49627798795700073, 0.40115922689437866, 0.5627331733703613, 0.3858276605606079, 0.4964867830276489, 0.5637965202331543, 0.10889744758605957, 0.23793429136276245, 0.9037463665008545, 0.0942266583442688, 0.46409690380096436, 0.9946193695068359, 0.6806185245513916, 0.5141565203666687, 0.06669503450393677, 0.7476889491081238, 0.1438596248626709, 0.3580678701400757, 0.33224183320999146, 0.4259563088417053, 0.5054691433906555, 0.9124037623405457, 0.5624194145202637, 0.9478464126586914, 0.8058562278747559, 0.18389302492141724, 0.7242520451545715, 0.1465519666671753, 0.2880874276161194, 0.6470613479614258, 0.6650960445404053, 0.8751140236854553, 0.339042067527771, 0.5008004307746887, 0.757411777973175, 0.016453921794891357, 0.8614903092384338, 0.08653879165649414, 0.5068912506103516, 0.4149916172027588, 0.23666352033615112, 0.5660855174064636, 0.9134593605995178, 0.3538402318954468, 0.20315295457839966, 0.31508058309555054, };
float kernel[9]     __attribute__ ((section ("dmem"))) = {0.00442582368850708, 0.7256969809532166, 0.25986814498901367, 0.16632986068725586, 0.21194928884506226, 0.7874780297279358, 0.7647868394851685, 0.883760929107666, 0.6813615560531616, };
float output[196]   __attribute__ ((section ("dmem"))) = {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, };
float expected[196] __attribute__ ((section ("dmem"))) = {1.4707666635513306, 0.8525369763374329, 1.084539532661438, 2.1422932147979736, 2.6825172901153564, 3.3721437454223633, 2.9203906059265137, 2.3674933910369873, 2.504912853240967, 1.408334493637085, 1.1817741394042969, 0.7141904830932617, 1.4250218868255615, 2.65584135055542, 2.02791428565979, 2.0679965019226074, 2.5623819828033447, 3.2818081378936768, 3.176321506500244, 2.7241737842559814, 2.6618270874023438, 1.636821985244751, 1.9077188968658447, 1.2800145149230957, 1.1178990602493286, 1.7616547346115112, 2.3815526962280273, 2.4628968238830566, 2.3618571758270264, 2.370368003845215, 2.4687514305114746, 3.008419990539551, 3.3217217922210693, 2.221870183944702, 2.1705198287963867, 2.1776797771453857, 2.5522079467773438, 2.8423984050750732, 2.6667566299438477, 2.204028844833374, 1.706357479095459, 2.1314239501953125, 2.65444278717041, 3.024667978286743, 2.8422632217407227, 2.513538122177124, 2.1708409786224365, 1.9707183837890625, 1.9725068807601929, 2.3389039039611816, 2.3452064990997314, 2.538832187652588, 2.9644112586975098, 2.8472952842712402, 2.3751895427703857, 1.2437812089920044, 2.5369033813476562, 1.5873754024505615, 2.2065672874450684, 2.8888189792633057, 2.934333562850952, 1.685279369354248, 1.6459546089172363, 1.738447904586792, 2.142197370529175, 2.26134991645813, 2.3091375827789307, 2.2009921073913574, 1.5549159049987793, 1.9423918724060059, 2.8202240467071533, 2.461594820022583, 1.9560256004333496, 2.1866931915283203, 2.113173007965088, 2.1965255737304688, 1.9826130867004395, 2.4599382877349854, 1.7090624570846558, 2.0237362384796143, 2.0497989654541016, 2.0965609550476074, 1.3875682353973389, 1.4997541904449463, 1.9654804468154907, 1.3668835163116455, 1.815205454826355, 2.368101119995117, 2.4463634490966797, 2.4276797771453857, 2.4563276767730713, 1.9227651357650757, 2.0246729850769043, 2.281961679458618, 2.2670540809631348, 2.8230247497558594, 2.969109058380127, 2.5417768955230713, 2.1390302181243896, 2.494769811630249, 1.7426526546478271, 1.6018683910369873, 1.652336597442627, 1.3636984825134277, 1.6398649215698242, 2.128415584564209, 2.623840093612671, 2.5120701789855957, 2.73907208442688, 1.8623698949813843, 2.3337466716766357, 1.6815637350082397, 1.5940423011779785, 1.4560271501541138, 1.317518949508667, 1.2503975629806519, 1.6158665418624878, 1.9264216423034668, 1.6496964693069458, 2.089055299758911, 2.417607307434082, 2.3456871509552, 3.249114513397217, 2.714674711227417, 2.682305335998535, 2.2874515056610107, 1.7981895208358765, 1.9439541101455688, 1.9349148273468018, 1.546670913696289, 1.8433669805526733, 2.223740577697754, 2.116027355194092, 2.587374448776245, 3.033743381500244, 2.199018716812134, 1.8949567079544067, 2.309756278991699, 1.885750651359558, 3.0864436626434326, 1.8223317861557007, 1.0520597696304321, 1.219002604484558, 1.6959879398345947, 2.1812307834625244, 2.1550722122192383, 2.3165431022644043, 2.3513545989990234, 2.3567240238189697, 2.1084489822387695, 1.0571081638336182, 2.444512128829956, 2.525263547897339, 2.7931623458862305, 2.0446949005126953, 2.117036819458008, 1.571473479270935, 2.1818535327911377, 1.9576886892318726, 2.4474759101867676, 2.160034656524658, 2.244729518890381, 1.859350323677063, 1.7121360301971436, 1.6203736066818237, 2.1656675338745117, 2.957859754562378, 3.520803689956665, 1.8512685298919678, 1.6255028247833252, 1.4815362691879272, 1.6742725372314453, 2.081570863723755, 2.284229278564453, 2.355191469192505, 2.7388598918914795, 3.227872610092163, 2.0006439685821533, 1.9768356084823608, 2.1515674591064453, 2.4046547412872314, 1.9978536367416382, 2.3366847038269043, 2.2138476371765137, 2.018960475921631, 2.0394082069396973, 2.135880708694458, 2.2378997802734375, 2.2407047748565674, 1.9576395750045776, 2.2527122497558594, 2.0668962001800537, 2.2400078773498535, 2.376486301422119, 2.4288387298583984, 1.8917549848556519, };


void convolution2D(float* input, float* kernel, float* output)
{
    for (int r = 0; r < OSIZE; r++) {
    for (int c = 0; c < OSIZE; c++) {
        int o_idx = r * OSIZE + c;
        output[o_idx] = 0.0;
        for (int m = 0; m < KSIZE; m++) {
        for (int n = 0; n < KSIZE; n++) {
            int y = r + m;
            int x = c + n;
            if (x >= 0 && x < ISIZE && y >= 0 && y < ISIZE) {
                int i_idx = y * ISIZE + x;
                int k_idx = m * KSIZE + n;
                output[o_idx] += input[i_idx] * kernel[k_idx];
            }
        }}
    }}
}

int main()
{

    bsg_set_tile_x_y();

    for (int i = 0; i < NOP_WAIT; i++) { asm volatile ("nop"); }

    bsg_print_time();

    for (int i = 0; i < ITERATIONS; i++) {
        convolution2D(&input[0], &kernel[0], &output[0]);
    }

    bsg_print_time();
    bsg_remote_ptr_io_store(IO_X_INDEX,0xEADC,&output[0]);

    //int errors = 0;
    //for (int r = 0; r < OSIZE; r++) {
    //    for (int c = 0; c < OSIZE; c++) {
    //        int index = r*OSIZE + c;
    //        if (abs(output[index] - expected[index]) > 0.0001) {
    //            errors += 1;
    //        }
    //    }
    //}

    //if (errors > 0) {
    //    bsg_fail();
    //    bsg_wait_while(1);
    //} else {
    //    bsg_finish();
    //    bsg_wait_while(1);
    //}

    bsg_finish();
    return 0;





    // //bsg_print_time();


    // return 0;
}
